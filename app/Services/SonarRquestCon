<?php

namespace App\Services;

require 'vendor/autoload.php';

class SonarGraphQLClient
{
    private $apiToken;
    private $url;

    public function __construct()
    {
        $dotenv = \Dotenv\Dotenv::createImmutable(base_path());
        $dotenv->load();

        // Load the API token and URL from environment variables
        $this->apiToken = getenv('SONAR_API_TOKEN');
        $this->url = getenv('SONAR_URL');
    }

    public function sendGraphQLRequest($query)
    {
        $headers = [
            'Authorization: Bearer ' . $this->apiToken,
            'Content-Type: application/json',
        ];

        $postData = json_encode([
            'query' => $query
        ]);

        $ch = curl_init($this->url);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS, $postData);

        $response = curl_exec($ch);
        if (curl_errno($ch)) {
            echo 'Request Error: ' . curl_error($ch);
        }

        curl_close($ch);
        return json_decode($response, true);
    }

    public function getServiceAbleAddress($id)
    {
        $query = '
        query {
          serviceableAddress(id: ' . $id . ') {
            id
            addressLine1
          }
        }
        ';
        return $this->sendGraphQLRequest($query);
    }
}
